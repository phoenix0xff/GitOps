name: Simulate Fault (GitOps - minimal)

on:
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: Minutes to keep the fault before auto-fix
        required: true
        default: "5"

env:
  APP_NAME: node-app
  MANIFEST_PATH: manifest/deployment.yaml
  GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
  GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
  PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

jobs:
  simulate-readiness-fault:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout manifests repo
        uses: actions/checkout@v4
        with:
          token: ${{ env.PERSONAL_ACCESS_TOKEN }}

      - name: Set up git
        run: |
          git config user.name  "${{ env.GIT_USERNAME }}"
          git config user.email "${{ env.GIT_EMAIL }}"

      - name: Install yq (binary)
        run: |
          YQ_VER=v4.44.3
          wget -q https://github.com/mikefarah/yq/releases/download/${YQ_VER}/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
          yq --version

      - name: Inject faulty readinessProbe
        id: inject
        shell: bash
        run: |
          set -euo pipefail
          set -x
          FILE="${{ env.MANIFEST_PATH }}"
          echo "=== BEFORE ==="
          yq e '.spec.template.spec.containers[0].readinessProbe' "$FILE" || true

          # Flip readiness path to a guaranteed-bad endpoint
          yq -i '
            .spec.template.spec.containers[0].readinessProbe.httpGet.path = "/nonexistent-health"
          ' "$FILE"

          # Force a rollout & ensure a textual diff even if path was already set
          export TS=$(date -u +%Y%m%d%H%M%S)
          yq -i '
            .spec.template.metadata.annotations = (.spec.template.metadata.annotations // {}) |
            .spec.template.metadata.annotations["sim-fault-run"] = strenv(TS)
          ' "$FILE"

          echo "=== AFTER ==="
          yq e '.spec.template.spec.containers[0].readinessProbe' "$FILE" || true
          yq e '.spec.template.metadata.annotations' "$FILE" || true

          echo "=== DIFF (working vs HEAD) ==="
          git diff -- "$FILE" || true

          # Only commit if the file actually changed
          if git diff --quiet -- "$FILE"; then
            echo "No content change detected; skipping commit."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Commit changes (tracked file), don't fail build if commit pushes nothing
          git commit -am "FAULT start: readinessProbe broken (sim-fault-run=$TS)" || true
          git push || true
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Hold fault
        if: steps.inject.outputs.changed == 'true'
        run: |
          echo "Keeping fault for ${{ github.event.inputs.duration_minutes }} minutes..."
          sleep $(( 60 * ${{ github.event.inputs.duration_minutes }} ))

      - name: Revert fault (auto-fix)
        if: steps.inject.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          set -x
          FILE="${{ env.MANIFEST_PATH }}"
          echo "Reverting manifest to healthy state"

          # Prefer a clean revert of the commit we just made; fall back to explicit restore.
          if git revert --no-edit HEAD; then
            git push || true
          else
            # Explicit restore: set path back to "/" and remove the annotation
            yq -i '
              .spec.template.spec.containers[0].readinessProbe.httpGet.path = "/" |
              .spec.template.metadata.annotations |= (del(.["sim-fault-run"]) // .)
            ' "$FILE"

            if git diff --quiet -- "$FILE"; then
              echo "Nothing to commit after explicit restore."
            else
              git commit -am "FAULT end: restore readinessProbe and annotations" || true
              git push || true
            fi
          fi
